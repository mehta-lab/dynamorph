# Preprocessing

## Purpose

Subsequent stages of the dynamorph pipeline require raw data to be formatted properly.  

This section addresses necessary data structures to execute this CLI:

```text
python run_preproc.py -c <path to config file>
```

## input

#### **folder structure and config file**

If all the image files are contained in "position directories" such as :
- "pos0", "pos1", "pos2" ... (generated by micro-manager grid generator), or such as:
- "A1-Site_0", "A1-Site_1", "A2-Site_0" ... (generated by micro-manager HCS site generator)
you should specify the config file flag `pos_dir` as `True`

If all the image files are **NOT** contained in "position directories", this module will assume position information is encoded in the file name:
- file name structure will contain "t###_p###_z###" string
- this module will parse the necessary values based on the above string structure

If you wish to process a subset of positions, you can specify those in the config file under "fov"

#### **file structure**

The desired input data format for the preprocessing cli should be one of either  `single-page tiffs` or `multi-page tiffs`

`single-page tiffs`:

Single-page tiffs are parsed by filename and must contain string elements:
- one of "Phase", "Retardance", "Brightfield"
- a 3 digit integer represeting the z-slice
- each single-page tiff is a .tif image file of shape (Y, X)

`multi-page tiffs`:

For the dynamorph paper, time series data showed slight jitter between time points.  We generated large z-stacks that were "stabilized" using Gunnar-Farnebeck optical flow.  The resulting "raw data" output had the following properties:

- one of "Phase", "Retardance, "Brightfield" in the file name
- dimensions of (T, Y, X)


In both cases, there is a check that every image of the series has the same X-Y dimensions

## outupt
 
The output file will be:

- a single .npy of shape `(T, C, Z, Y, X)`
- C represents "channel" and will always be length 3
- Channel index 0, 1, 2 will correspond to "Phase", "Retardance", and "Brightfield" respectively
- If one of the above channels is not present in the raw data, that array will be empty in the output.
- .npy file is named after the position.  So it would appear as "A1-Site_0.npy", "A1-Site_1.npy" etc.. or "pos0.npy", "pos1.npy" ...
